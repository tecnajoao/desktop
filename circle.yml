machine:
  node:
    version: 6.11.3
  services:
    - docker

dependencies:
  cache_directories:
    - "src/node_modules"
    - ~/.cache/yarn
    - ~/.cache/electron
    - ~/.cache/electron-builder
  override:
    - yarn
  post:
    - if git status --short | grep yarn\.lock; then echo 'yarn.lock is not updated'; false; else true; fi

    - sudo apt-get update
    - sudo apt-get -y install jq

    - npm run build
    - docker pull electronuserland/electron-builder:wine
    - docker run --rm -it -v `pwd`:/project electronuserland/electron-builder:wine npm run package:windows
    - docker run --rm -it -v `pwd`:/project electronuserland/electron-builder:wine npm run package:mac
    - docker run --rm -it -v `pwd`:/project electronuserland/electron-builder:wine npm run package:linux
    - sh -x ./scripts/cp_artifacts.sh release $CIRCLE_ARTIFACTS

test:
  override:
    - yarn test
  post:
    - mv test-results.xml $CIRCLE_TEST_REPORTS/
